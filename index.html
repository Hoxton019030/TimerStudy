<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>極簡圓心設定計時器</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background-color: #121212;
    color: #ffffff;
  }

  .circle-container {
    position: relative;
    width: 320px;
    height: 320px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #progressCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  /* 圓心區域容器 */
  .timer-center {
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* 時間顯示與輸入框共用樣式 */
  #timerDisplay, #durationInput {
    font-size: 48px;
    font-weight: bold;
    color: #ffffff;
    background: transparent;
    border: none;
    text-align: center;
    width: 150px;
    outline: none;
    font-family: inherit;
  }

  /* 隱藏輸入框的上下箭頭 */
  #durationInput::-webkit-inner-spin-button,
  #durationInput::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .unit-label {
    font-size: 14px;
    color: #666;
    margin-top: -5px;
  }

  #controls {
    margin-top: 40px;
  }

  button {
    font-size: 16px;
    margin: 0 8px;
    padding: 10px 24px;
    border: 1px solid #333;
    background: #1e1e1e;
    color: #ffffff;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
  }

  button:hover:not(:disabled) {
    background: #333;
    border-color: #555;
  }

  button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  #volumeControl {
    margin-top: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #666;
    font-size: 14px;
  }

  #volumeSlider {
    width: 120px;
    accent-color: #00cc66;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="circle-container">
  <canvas id="progressCanvas" width="320" height="320"></canvas>
  
  <div class="timer-center">
    <div id="timerDisplay" style="display: none;">00:00</div>
    <input type="number" id="durationInput" value="90" title="點擊修改分鐘">
    <div id="unitLabel" class="unit-label">MINUTES</div>
  </div>
</div>

<div id="controls">
  <button id="startBtn">開始</button>
  <button id="clearBtn">清空</button>
  <button id="stopBtn">停止</button>
  
  <div id="volumeControl">
    <span>音量</span>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
  </div>
</div>

<audio id="sound1" src="takeBreak.mp3"></audio>
<audio id="sound2" src="start.mp3"></audio>

<script>
  const canvas = document.getElementById('progressCanvas');
  const ctx = canvas.getContext('2d');
  const timerDisplay = document.getElementById('timerDisplay');
  const durationInput = document.getElementById('durationInput');
  const unitLabel = document.getElementById('unitLabel');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const clearBtn = document.getElementById('clearBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const sound1 = document.getElementById('sound1');
  const sound2 = document.getElementById('sound2');

  let totalSeconds = (parseInt(localStorage.getItem('totalSeconds')) || 90) * 60;
  let remainingSeconds = parseInt(localStorage.getItem('remaining')) || totalSeconds;
  let restSegments = JSON.parse(localStorage.getItem('restSegments') || '[]');
  
  let interval = null;
  let soundTimeout = null;
  let isRunning = false;
  let isPaused = false;

  // 初始化狀態
  durationInput.value = totalSeconds / 60;
  const savedVolume = parseFloat(localStorage.getItem('volume'));
  volumeSlider.value = isNaN(savedVolume) ? 1 : savedVolume;
  sound1.volume = sound2.volume = volumeSlider.value;

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  let glowStart = Date.now();

  function drawCircle(segments, total) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const center = canvas.width / 2;
    const radius = 140;
    const elapsed = (Date.now() - glowStart) / 1000;
    const glow = 4 + Math.sin(elapsed * 2) * 4;

    // 底圈
    ctx.beginPath();
    ctx.arc(center, center, radius, 0, Math.PI * 2);
    ctx.strokeStyle = '#252525';
    ctx.lineWidth = 8;
    ctx.stroke();

    // 進度段
    segments.forEach(seg => {
      const startAngle = -Math.PI / 2 + (Math.PI * 2) * (seg.start / total);
      const endAngle = -Math.PI / 2 + (Math.PI * 2) * (seg.end / total);
      ctx.beginPath();
      ctx.arc(center, center, radius, startAngle, endAngle);
      ctx.strokeStyle = seg.color;
      ctx.lineWidth = 8;
      ctx.lineCap = 'round';
      ctx.shadowColor = seg.color;
      ctx.shadowBlur = glow;
      ctx.stroke();
      ctx.shadowBlur = 0;
    });
  }

  function updateUI() {
    if (isRunning || isPaused || remainingSeconds < totalSeconds) {
      // 計時中：顯示倒數文字，隱藏輸入框
      timerDisplay.style.display = 'block';
      durationInput.style.display = 'none';
      unitLabel.style.visibility = 'hidden';
      timerDisplay.textContent = formatTime(remainingSeconds);
    } else {
      // 初始/清空狀態：顯示輸入框
      timerDisplay.style.display = 'none';
      durationInput.style.display = 'block';
      unitLabel.style.visibility = 'visible';
    }

    const currentTime = totalSeconds - remainingSeconds;
    const segments = [{ start: 0, end: currentTime, color: '#FFA500' }];
    restSegments.forEach(s => {
      segments.push({ start: s.start, end: Math.min(currentTime, s.start + 12), color: '#00CC66' });
    });
    drawCircle(segments, totalSeconds);
  }

  function startTimer() {
    if (isRunning) return;

    if (!isPaused && remainingSeconds === totalSeconds) {
      const mins = parseInt(durationInput.value);
      if (isNaN(mins) || mins <= 0) return;
      totalSeconds = mins * 60;
      remainingSeconds = totalSeconds;
      localStorage.setItem('totalSeconds', mins);
    }

    isRunning = true;
    isPaused = false;
    startBtn.disabled = true;
    stopBtn.disabled = false;

    scheduleNextSound();
    interval = setInterval(() => {
      remainingSeconds--;
      if (remainingSeconds <= 0) {
        clearInterval(interval);
        clearAll();
        alert("時間到！");
      } else {
        localStorage.setItem('remaining', remainingSeconds);
      }
    }, 1000);
  }

  function scheduleNextSound() {
    const delay = Math.floor(Math.random() * 120) + 180; // 3-5分鐘
    soundTimeout = setTimeout(() => {
      restSegments.push({ start: totalSeconds - remainingSeconds });
      localStorage.setItem('restSegments', JSON.stringify(restSegments));
      sound1.play();
      setTimeout(() => sound2.play(), 12000);
      scheduleNextSound();
    }, delay * 1000);
  }

  function stopTimer() {
    clearInterval(interval);
    clearTimeout(soundTimeout);
    isRunning = false;
    isPaused = true;
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  function clearAll() {
    stopTimer();
    localStorage.removeItem('remaining');
    localStorage.removeItem('restSegments');
    remainingSeconds = totalSeconds;
    restSegments = [];
    isPaused = false;
    updateUI();
  }

  startBtn.addEventListener('click', startTimer);
  stopBtn.addEventListener('click', stopTimer);
  clearBtn.addEventListener('click', clearAll);
  volumeSlider.addEventListener('input', () => {
    sound1.volume = sound2.volume = volumeSlider.value;
    localStorage.setItem('volume', volumeSlider.value);
  });

  // 動畫循環
  function animate() {
    updateUI();
    requestAnimationFrame(animate);
  }
  
  stopBtn.disabled = true;
  animate();
</script>

</body>
</html>