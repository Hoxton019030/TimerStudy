<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>極簡圓心倒數計時器</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background-color: #121212;
    color: #ffffff;
    overflow: hidden;
  }

  .circle-container {
    position: relative;
    width: 320px;
    height: 320px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #progressCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .timer-center {
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #timerDisplay, #durationInput {
    font-size: 48px;
    font-weight: bold;
    color: #ffffff;
    background: transparent;
    border: none;
    text-align: center;
    width: 160px;
    outline: none;
    font-family: inherit;
  }

  #durationInput::-webkit-inner-spin-button,
  #durationInput::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .unit-label {
    font-size: 14px;
    color: #666;
    margin-top: -5px;
    letter-spacing: 2px;
  }

  #controls {
    margin-top: 40px;
  }

  button {
    font-size: 16px;
    margin: 0 8px;
    padding: 10px 24px;
    border: 1px solid #333;
    background: #1e1e1e;
    color: #ffffff;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
  }

  button:hover:not(:disabled) {
    background: #333;
    border-color: #555;
  }

  button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  #volumeControl {
    margin-top: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: #666;
    font-size: 14px;
  }

  #volumeSlider {
    width: 120px;
    accent-color: #00cc66;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="circle-container">
  <canvas id="progressCanvas" width="320" height="320"></canvas>
  
  <div class="timer-center">
    <div id="timerDisplay" style="display: none;">00:00</div>
    <input type="number" id="durationInput" value="90" title="點擊修改分鐘">
    <div id="unitLabel" class="unit-label">MINUTES</div>
  </div>
</div>

<div id="controls">
  <button id="startBtn">開始</button>
  <button id="stopBtn" disabled>暫停</button>
  <button id="clearBtn">重置</button>
  
  <div id="volumeControl">
    <span>音量</span>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
  </div>
</div>

<audio id="finishSound" src="takeBreak.mp3"></audio>

<script>
  const canvas = document.getElementById('progressCanvas');
  const ctx = canvas.getContext('2d');
  const timerDisplay = document.getElementById('timerDisplay');
  const durationInput = document.getElementById('durationInput');
  const unitLabel = document.getElementById('unitLabel');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const clearBtn = document.getElementById('clearBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const finishSound = document.getElementById('finishSound');

  // 狀態變數
  let totalSeconds = (parseInt(localStorage.getItem('totalSeconds')) || 90) * 60;
  let remainingSeconds = parseInt(localStorage.getItem('remaining')) || totalSeconds;
  let interval = null;
  let isRunning = false;
  let isPaused = false;

  // 初始化音量與輸入框
  durationInput.value = totalSeconds / 60;
  const savedVolume = localStorage.getItem('volume');
  if (savedVolume !== null) {
    volumeSlider.value = savedVolume;
    finishSound.volume = savedVolume;
  }

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  function drawCircle() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const center = canvas.width / 2;
    const radius = 140;
    
    // 計算進度比例 (0 到 1)
    const progress = remainingSeconds / totalSeconds;

    // 1. 底圈 (深灰色)
    ctx.beginPath();
    ctx.arc(center, center, radius, 0, Math.PI * 2);
    ctx.strokeStyle = '#252525';
    ctx.lineWidth = 8;
    ctx.stroke();

    // 2. 進度條 (橘色) - 順時針縮短
    if (remainingSeconds > 0) {
      const startAngle = -Math.PI / 2;
      const endAngle = -Math.PI / 2 + (Math.PI * 2 * progress);
      
      ctx.beginPath();
      ctx.arc(center, center, radius, startAngle, endAngle);
      ctx.strokeStyle = '#FFA500';
      ctx.lineWidth = 10;
      ctx.lineCap = 'round';
      
      // 光暈效果
      ctx.shadowColor = '#FFA500';
      ctx.shadowBlur = isRunning ? 10 : 0;
      ctx.stroke();
      ctx.shadowBlur = 0;
    }
  }

  function updateUI() {
    // 判斷是否在倒數狀態
    const isCounting = isRunning || isPaused || (remainingSeconds < totalSeconds && remainingSeconds > 0);

    if (isCounting) {
      timerDisplay.style.display = 'block';
      durationInput.style.display = 'none';
      unitLabel.style.visibility = 'hidden';
      timerDisplay.textContent = formatTime(remainingSeconds);
    } else {
      timerDisplay.style.display = 'none';
      durationInput.style.display = 'block';
      unitLabel.style.visibility = 'visible';
      timerDisplay.style.color = "#ffffff";
    }
    drawCircle();
  }

  function startTimer() {
    if (isRunning) return;

    // 如果是重新開始（非暫停恢復），讀取輸入框數值
    if (!isPaused) {
      const mins = parseInt(durationInput.value);
      if (isNaN(mins) || mins <= 0) {
        alert("請輸入有效的分鐘數");
        return;
      }
      totalSeconds = mins * 60;
      remainingSeconds = totalSeconds;
      localStorage.setItem('totalSeconds', mins);
    }

    isRunning = true;
    isPaused = false;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    startBtn.textContent = "繼續";

    interval = setInterval(() => {
      remainingSeconds--;
      localStorage.setItem('remaining', remainingSeconds);

      if (remainingSeconds <= 0) {
        finishTimer();
      }
    }, 1000);
  }

  function finishTimer() {
    clearInterval(interval);
    isRunning = false;
    isPaused = false;
    remainingSeconds = 0;
    localStorage.removeItem('remaining');

    // 播放音效
    finishSound.play().catch(err => console.log("音效播放被攔截，請確保有過點擊行為", err));

    // UI 反饋
    timerDisplay.textContent = "00:00";
    timerDisplay.style.color = "#ff4444";
    startBtn.disabled = false;
    startBtn.textContent = "開始";
    stopBtn.disabled = true;

    // 延遲跳出 alert 免得阻斷音效播放
    setTimeout(() => {
      alert("時間到！");
    }, 100);
  }

  function stopTimer() {
    clearInterval(interval);
    isRunning = false;
    isPaused = true;
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  function clearAll() {
    stopTimer();
    localStorage.removeItem('remaining');
    isPaused = false;
    const mins = parseInt(durationInput.value) || 90;
    totalSeconds = mins * 60;
    remainingSeconds = totalSeconds;
    startBtn.textContent = "開始";
    updateUI();
  }

  // 事件監聽
  startBtn.addEventListener('click', startTimer);
  stopBtn.addEventListener('click', stopTimer);
  clearBtn.addEventListener('click', clearAll);
  volumeSlider.addEventListener('input', () => {
    finishSound.volume = volumeSlider.value;
    localStorage.setItem('volume', volumeSlider.value);
  });

  // 動畫循環 (處理圓環重繪)
  function animate() {
    updateUI();
    requestAnimationFrame(animate);
  }
  
  animate();
</script>

</body>
</html>